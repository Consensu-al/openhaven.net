---
// Random media embed (SoundCloud, YouTube, Spotify, etc.)
// Reads .html files from src/data/media-embeds/
// Listens for shuffle-media event to re-randomize
import fs from "node:fs";
import path from "node:path";

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

const embedDir = path.join(process.cwd(), "src/data/media-embeds");
let embeds: string[] = [];

try {
  const files = fs.readdirSync(embedDir).filter((file) => file.endsWith(".html"));
  embeds = files.map(file => fs.readFileSync(path.join(embedDir, file), "utf-8"));
} catch (err) {
  // Directory doesn't exist or can't be read
}
---

{embeds.length > 0 && (
  <div class:list={[className, "embed-container"]} data-embeds={JSON.stringify(embeds)}></div>
)}

<script>
  function pickRandomEmbed() {
    const container = document.querySelector('div[data-embeds]') as HTMLDivElement;
    if (container) {
      const embeds = JSON.parse(container.dataset.embeds || '[]');
      if (embeds.length > 0) {
        container.innerHTML = embeds[Math.floor(Math.random() * embeds.length)];
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    pickRandomEmbed();
  });

  // Listen for shuffle event from image click
  window.addEventListener('shuffle-media', () => {
    pickRandomEmbed();
  });
</script>

<style>
  .embed-container {
    border-radius: 4px;
    max-width: 100%;
  }

  .embed-container :global(iframe) {
    display: block;
    width: 100% !important;
    max-width: 100%;
    border: none;
  }

  .embed-container :global(*) {
    max-width: 100%;
  }
</style>
