---
// Embeds all images, client-side JS picks randomly on each page load
// Click to re-randomize both image and embed
import fs from "node:fs";
import path from "node:path";

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

const imageDir = path.join(process.cwd(), "public/images/sidebar");
let images: string[] = [];

try {
  images = fs.readdirSync(imageDir).filter((file) => {
    const ext = path.extname(file).toLowerCase();
    return [".jpg", ".jpeg", ".png", ".gif", ".webp", ".svg"].includes(ext);
  }).map(file => `/images/sidebar/${file}`);
} catch (err) {
  // Directory doesn't exist or can't be read
}
---

{images.length > 0 && (
  <img
    src=""
    alt=""
    class={className}
    data-images={JSON.stringify(images)}
    title="Click to shuffle"
  />
)}

<script>
  function pickRandomImage() {
    const img = document.querySelector('img[data-images]') as HTMLImageElement;
    if (img) {
      const images = JSON.parse(img.dataset.images || '[]');
      if (images.length > 0) {
        img.src = images[Math.floor(Math.random() * images.length)];
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    pickRandomImage();

    const img = document.querySelector('img[data-images]') as HTMLImageElement;
    if (img) {
      img.style.cursor = 'pointer';
      img.addEventListener('click', () => {
        pickRandomImage();
        // Dispatch event so embed can also re-randomize
        window.dispatchEvent(new CustomEvent('shuffle-media'));
      });
    }
  });
</script>

<style>
  img {
    width: 100%;
    height: auto;
    border-radius: 4px;
    transition: opacity 0.15s;
  }

  img:hover {
    opacity: 0.85;
  }
</style>
